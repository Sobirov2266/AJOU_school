{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Teachers{% endblock %}

{% block content %}

<main class="main-content">

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h2>O‘qituvchilar</h2>
            <p>Barcha o‘qituvchilar ro‘yxati</p>
        </div>
    </header>

    <!-- Action Bar -->
    <div class="action-bar">
        <form method="get" class="search-box">
            <i class="fas fa-search"></i>
            <input
                type="text"
                name="q"
                value="{{ request.GET.q }}"
                placeholder="Ism, familiya, passport yoki JSHSHR"
            >
        </form>

        <div style="display:flex; gap:10px; align-items:center;">
            <div style="display:flex; gap:8px; align-items:center;">
                <a class="btn btn-secondary" href="{% url 'admin_panel:teacher_export_excel' %}">
                    <i class="fa-solid fa-file-excel"></i>
                    Excel
                </a>
                <a class="btn btn-secondary" href="{% url 'admin_panel:teacher_export_pdf' %}">
                    <i class="fa-solid fa-file-pdf"></i>
                    PDF
                </a>
            </div>

            <a class="btn btn-primary" href="{% url 'admin_panel:teacher_create' %}">
                <i class="fas fa-user-plus"></i>
                Yangi o‘qituvchi
            </a>
        </div>
    </div>

    <!-- Filter Panel (yopiladigan) -->
    <div class="filter-panel-card" id="filterPanel">
        <div class="filter-panel-header">
            <div class="filter-panel-title">
                <i class="fas fa-filter filter-panel-icon"></i>
                <span>Filtrlar</span>
            </div>
            <button type="button" class="filter-panel-close" id="closeFilterPanel" aria-label="Yopish">
                <span class="filter-close-text">Yopish</span>
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="get" id="teacherFiltersForm" class="filter-panel-body">
            <input type="hidden" name="q" value="{{ filters.q }}">
            <div class="filter-panel-grid">
                <div class="filter-field">
                    <label>Ism yoki familiya</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-user filter-input-icon"></i>
                        <input
                            type="text"
                            name="name"
                            value="{{ filters.name }}"
                            placeholder="Ism yoki familiya"
                            class="filter-input"
                            autocomplete="off"
                        >
                    </div>
                </div>

                <div class="filter-field">
                    <label>Passport / ID</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-id-card filter-input-icon"></i>
                        <input
                            type="text"
                            name="passport"
                            value="{{ filters.passport }}"
                            placeholder="Passport / ID"
                            class="filter-input"
                            autocomplete="off"
                        >
                    </div>
                </div>

                <div class="filter-field">
                    <label>JSHSHR</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-hashtag filter-input-icon"></i>
                        <input
                            type="text"
                            name="jshshr"
                            value="{{ filters.jshshr }}"
                            placeholder="JSHSHR"
                            class="filter-input"
                            autocomplete="off"
                        >
                    </div>
                </div>

                <div class="filter-field">
                    <label>Tug‘ilgan yili</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-calendar-alt filter-input-icon"></i>
                        <input
                            type="number"
                            name="birth_year"
                            value="{{ filters.birth_year }}"
                            class="filter-input"
                            placeholder="Masalan: 1998"
                        >
                    </div>
                </div>

                <div class="filter-field">
                    <label>Jinsi</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-venus-mars filter-input-icon"></i>
                        <select name="gender" class="filter-select">
                            <option value="">Barchasi</option>
                            <option value="male" {% if filters.gender == "male" %}selected{% endif %}>Erkak</option>
                            <option value="female" {% if filters.gender == "female" %}selected{% endif %}>Ayol</option>
                        </select>
                    </div>
                </div>

                <div class="filter-field">
                    <label>Status</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-toggle-on filter-input-icon"></i>
                        <select name="status" class="filter-select">
                            <option value="">Barchasi</option>
                            <option value="active" {% if filters.status == "active" %}selected{% endif %}>Faol</option>
                            <option value="inactive" {% if filters.status == "inactive" %}selected{% endif %}>Nofaol</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filter-panel-actions">
                <a href="{% url 'admin_panel:teacher_list' %}" class="btn-filter-tozalash">
                    <i class="fas fa-trash-alt"></i>
                    Tozalash
                </a>
                <button type="submit" class="btn-filter-qollash">
                    <i class="fas fa-check"></i>
                    Qo'llash
                </button>
            </div>
        </form>
    </div>

    <button type="button" class="btn-show-filters" id="showFilterPanel" style="display:none;">
        <i class="fas fa-filter"></i>
        Filtrlarni ko'rsatish
    </button>

    <!-- Table -->
    <div class="card table-container">
        <div class="card-header">
            <h3>O‘qituvchilar ro‘yxati</h3>
            <span>{{ teacher_count }} ta o‘qituvchi</span>
        </div>

        <div class="card-body table-responsive">
            <table class="teachers-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>F.I.Sh</th>
                        <th>Passport</th>
                        <th>JSHSHR</th>
                        <th>Tug‘ilgan yili</th>
                        <th>Jinsi</th>
                        <th>Status</th>
                        <th>Amallar</th>

                    </tr>
                </thead>
                <tbody>
                    {% for teacher in teachers %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <div class="user-cell">
                                {% if teacher.photo %}
                                    <img
                                        class="avatar avatar-img js-photo-preview"
                                        src="{{ teacher.photo.url }}"
                                        alt=""
                                        data-photo-url="{{ teacher.photo.url }}"
                                    >
                                {% else %}
                                    <div class="avatar">
                                        {{ teacher.last_name|default:""|slice:":1" }}{{ teacher.first_name|default:""|slice:":1" }}
                                    </div>
                                {% endif %}
                                <div>
                                    {{ teacher.last_name }} {{ teacher.first_name }}
                                </div>
                            </div>
                        </td>
                        <td>{{ teacher.passport_id|default:"—" }}</td>
                        <td>{{ teacher.jshshr|default:"—" }}</td>
                        <td>{{ teacher.birth_year|default:"—" }}</td>
                        <td>
                            {% if teacher.gender == 'male' %} Erkak
                            {% elif teacher.gender == 'female' %} Ayol
                            {% else %} — {% endif %}
                        </td>
                        <td>
                            <span
                                class="status-badge js-teacher-status {% if teacher.user.is_active %}status-active{% else %}status-inactive{% endif %}"
                                role="button"
                                tabindex="0"
                                data-teacher-id="{{ teacher.id }}"
                                data-active="{% if teacher.user.is_active %}1{% else %}0{% endif %}"
                                title="Statusni o‘zgartirish"
                            >
                                {% if teacher.user.is_active %}Faol{% else %}Nofaol{% endif %}
                            </span>

                        </td>
                        <td>
                            <div class="action-buttons">
                                <!-- Edit -->
                                <button
                                    class="action-btn edit"
                                    data-id="{{ teacher.id }}"
                                    data-first-name="{{ teacher.first_name }}"
                                    data-last-name="{{ teacher.last_name }}"
                                    data-birth-year="{{ teacher.birth_year }}"
                                    data-gender="{{ teacher.gender }}"
                                    data-active="{{ teacher.user.is_active }}"
                                >
                                    <i class="fa-solid fa-pen"></i>
                                </button>


                                <!-- Delete -->
                                <button class="action-btn delete" onclick="deleteTeacher('{{ teacher.id }}')">
                                    <i class="fa-solid fa-trash"></i>
                                </button>

                            </div>
                        </td>

                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted" style="text-align:center;">Hech qanday o‘qituvchi topilmadi</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

  {% if is_paginated %}
  <nav class="pagination" aria-label="Pagination">
    <a
      class="page-link {% if not page_obj.has_previous %}disabled{% endif %}"
      {% if page_obj.has_previous %}
      href="?page={{ page_obj.previous_page_number }}{% if qs %}&{{ qs }}{% endif %}"
      {% endif %}
    >
      Previous
    </a>

    {% for num in paginator.page_range %}
      {% if num == page_obj.number %}
        <span class="page-link active">{{ num }}</span>
      {% else %}
        <a class="page-link" href="?page={{ num }}{% if qs %}&{{ qs }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}

    <a
      class="page-link {% if not page_obj.has_next %}disabled{% endif %}"
      {% if page_obj.has_next %}
      href="?page={{ page_obj.next_page_number }}{% if qs %}&{{ qs }}{% endif %}"
      {% endif %}
    >
      Next
    </a>
  </nav>
  {% endif %}

</main>

<!-- Photo preview modal (small preview) -->
<div class="modal" id="photoPreviewModal" aria-hidden="true">
    <div class="photo-preview-card" role="dialog" aria-modal="true">
        <button type="button" class="photo-preview-close" aria-label="Yopish">&times;</button>
        <img id="photoPreviewImg" src="" alt="">
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterPanel = document.getElementById('filterPanel');
    const showBtn = document.getElementById('showFilterPanel');

    document.getElementById('closeFilterPanel').addEventListener('click', function() {
        filterPanel.classList.add('filter-panel-hidden');
        if (showBtn) showBtn.style.display = 'inline-flex';
    });

    if (showBtn) {
        showBtn.addEventListener('click', function() {
            filterPanel.classList.remove('filter-panel-hidden');
            showBtn.style.display = 'none';
        });
    }
});
</script>

<script>
// Photo preview logic:
// Clicking on an avatar image opens a small modal preview.
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('photoPreviewModal');
    const img = document.getElementById('photoPreviewImg');
    const closeBtn = modal ? modal.querySelector('.photo-preview-close') : null;

    if (!modal || !img) return;

    const open = (url) => {
        img.src = url;
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
    };

    const close = () => {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        img.src = '';
    };

    document.querySelectorAll('.js-photo-preview[data-photo-url]').forEach((el) => {
        el.style.cursor = 'pointer';
        el.addEventListener('click', () => {
            const url = el.getAttribute('data-photo-url');
            if (url) open(url);
        });
    });

    if (closeBtn) closeBtn.addEventListener('click', close);

    modal.addEventListener('click', (e) => {
        if (e.target === modal) close();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
    });
});
</script>

<!-- MODAL: EDIT TEACHER -->
<div class="modal" id="teacherEditModal">
    <div class="modal-content modern-modal">

        <div class="modal-header">
            <h3>O‘qituvchini tahrirlash</h3>
            <button class="modal-close">&times;</button>
        </div>

        <form method="post" action="{% url 'admin_panel:teacher_update' %}" class="modal-form">
            {% csrf_token %}
            <input type="hidden" name="teacher_id" id="edit_teacher_id">

            <div class="form-grid">
                <div class="form-group">
                    <label>Ism</label>
                    <input type="text" name="first_name" id="edit_first_name" placeholder="Ismi">
                </div>

                <div class="form-group">
                    <label>Familiya</label>
                    <input type="text" name="last_name" id="edit_last_name" placeholder="Familiyasi">
                </div>

                <div class="form-group">
                    <label>Tug‘ilgan yili</label>
                    <input type="number" name="birth_year" id="edit_birth_year" placeholder="1998">
                </div>

                <div class="form-group">
                    <label>Jinsi</label>
                    <select name="gender" id="edit_gender">
                        <option value="">Tanlang</option>
                        <option value="male">Erkak</option>
                        <option value="female">Ayol</option>
                    </select>
                </div>


                <div class="form-group full">
                    <label>Status</label>
                    <select name="is_active" id="edit_is_active">
                        <option value="1">Faol</option>
                        <option value="0">Nofaol</option>
                    </select>
                </div>

                <div class="form-group full">
                    <label>Yangi parol (ixtiyoriy)</label>
                    <input
                        type="password"
                        name="new_password"
                        placeholder="Agar o‘zgartirmoqchi bo‘lsangiz kiriting"
                        autocomplete="new-password"
                    >
                    <small style="color:#6b7280">
                        Agar bo‘sh qoldirilsa, parol o‘zgarmaydi
                    </small>
                </div>


            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-save"></i> Saqlash
                </button>
                <button type="button" class="btn btn-secondary modal-close">
                    Bekor qilish
                </button>
            </div>
        </form>

    </div>
</div>


<!-- tahrirlash uchun -->
<script>
document.querySelectorAll(".action-btn.edit").forEach(btn => {
    btn.addEventListener("click", () => {
        document.getElementById("teacherEditModal").classList.add("active");

        document.getElementById("edit_teacher_id").value = btn.dataset.id;
        document.getElementById("edit_first_name").value = btn.dataset.firstName || "";
        document.getElementById("edit_last_name").value = btn.dataset.lastName || "";
        document.getElementById("edit_birth_year").value = btn.dataset.birthYear || "";
        document.getElementById("edit_gender").value = btn.dataset.gender || "";
        document.getElementById("edit_is_active").value =
            btn.dataset.active === "True" ? "1" : "0";

    });
});


document.querySelectorAll(".modal-close").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".modal").forEach(m => m.classList.remove("active"));
    });
});
</script>


<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

document.addEventListener("DOMContentLoaded", () => {
    const csrfToken = getCookie("csrftoken");

    document.querySelectorAll(".js-teacher-status[data-teacher-id]").forEach((badge) => {
        const teacherId = badge.dataset.teacherId;

        const onToggle = async () => {
            if (!teacherId) return;
            if (!confirm("Statusni o‘zgartirmoqchimisiz?")) return;

            try {
                const res = await fetch(`/admin-panel/teachers/toggle-status/${teacherId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken || "",
                    },
                    body: JSON.stringify({})
                });

                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || "Toggle failed");
                }

                const isActive = data.new_status === "active";
                badge.dataset.active = isActive ? "1" : "0";

                badge.classList.toggle("status-active", isActive);
                badge.classList.toggle("status-inactive", !isActive);
                badge.textContent = isActive ? "Faol" : "Nofaol";
            } catch (e) {
                alert("Statusni o‘zgartirishda xatolik yuz berdi.");
            }
        };

        badge.addEventListener("click", onToggle);
        badge.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                onToggle();
            }
        });
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // create modal removed; teacher create is now a dedicated page
});
</script>



<!-- O'chirish uchun uchun  -->
<script>
function deleteTeacher(id) {
    if (confirm("O‘qituvchini o‘chirishni tasdiqlaysizmi?")) {
        window.location.href = `/admin-panel/teachers/delete/${id}/`;
    }
}
</script>




{% endblock %}
