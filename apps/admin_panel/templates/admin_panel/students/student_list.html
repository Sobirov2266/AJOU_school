{% extends "admin_panel/base.html" %}
{% load static %}

{% block title %}Students{% endblock %}

{% block content %}

<main class="main-content">

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h2>O‘quvchilar</h2>
            <p>Barcha o‘quvchilar ro‘yxati</p>
        </div>
    </header>

    <!-- Action Bar -->
    <div class="action-bar">
        <form method="get" class="search-box">
            <i class="fas fa-search"></i>
            <input
                type="text"
                name="q"
                value="{{ request.GET.q }}"
                placeholder="Ism, familiya, passport yoki ID"
            >
        </form>

        <div style="display:flex; gap:10px; align-items:center;">
            <div style="display:flex; gap:8px; align-items:center;">
                <a class="btn btn-secondary" href="{% url 'admin_panel:students_export_excel' %}">
                    <i class="fa-solid fa-file-excel"></i>
                    Excel
                </a>
                <a class="btn btn-secondary" href="{% url 'admin_panel:students_export_pdf' %}">
                    <i class="fa-solid fa-file-pdf"></i>
                    PDF
                </a>
            </div>

            <a href="{% url 'admin_panel:student_create' %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                Yangi o‘quvchi
            </a>
        </div>
    </div>

    <!-- Filter Panel (yopiladigan) -->
    <div class="filter-panel-card" id="filterPanel">
        <div class="filter-panel-header">
            <div class="filter-panel-title">
                <i class="fas fa-filter filter-panel-icon"></i>
                <span>Filtrlar</span>
            </div>
            <button type="button" class="filter-panel-close" id="closeFilterPanel" aria-label="Yopish">
                <span class="filter-close-text">Yopish</span>
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="get" id="studentFiltersForm" class="filter-panel-body">
            <input type="hidden" name="q" value="{{ filters.q }}">
            <div class="filter-panel-grid">
                <div class="filter-field">
                    <label>Ism yoki familiya</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-user filter-input-icon"></i>
                        <input type="text" name="name" value="{{ filters.name }}" placeholder="Ism yoki familiya"
                               class="filter-input" autocomplete="off">
                    </div>
                </div>
                <div class="filter-field">
                    <label>Passport / ID</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-id-card filter-input-icon"></i>
                        <input type="text" name="passport" value="{{ filters.passport }}" placeholder="Passport / ID"
                               class="filter-input" autocomplete="off">
                    </div>
                </div>
                <div class="filter-field">
                    <label>Tug'ilgan sana</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-calendar-alt filter-input-icon"></i>
                        <input type="date" name="birth_date" value="{{ filters.birth_date }}"
                               class="filter-input filter-date" placeholder="dd.mm.yyyy">
                    </div>
                </div>
                <div class="filter-field">
                    <label>Sinfi</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-school filter-input-icon"></i>
                        <select name="class_id" class="filter-select">
                            <option value="">Barcha sinflar</option>
                            {% for c in classes %}
                                <option value="{{ c.id }}" {% if filters.class_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="filter-field">
                    <label>Status</label>
                    <div class="filter-input-wrap">
                        <i class="fas fa-toggle-on filter-input-icon"></i>
                        <select name="status" class="filter-select">
                            <option value="">Barchasi</option>
                            <option value="active" {% if filters.status == "active" %}selected{% endif %}>Faol</option>
                            <option value="inactive" {% if filters.status == "inactive" %}selected{% endif %}>Nofaol</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filter-panel-actions">
                <a href="{% url 'admin_panel:admin_students' %}" class="btn-filter-tozalash">
                    <i class="fas fa-trash-alt"></i>
                    Tozalash
                </a>
                <button type="submit" class="btn-filter-qollash">
                    <i class="fas fa-check"></i>
                    Qo'llash
                </button>
            </div>
        </form>
    </div>

    <button type="button" class="btn-show-filters" id="showFilterPanel" style="display:none;">
        <i class="fas fa-filter"></i>
        Filtrlarni ko'rsatish
    </button>

    <!-- Table -->
    <div class="card table-container">
        <div class="card-header">
            <h3>O‘quvchilar ro‘yxati</h3>
            <span>{{ total_students }} ta o‘quvchi</span>
        </div>

        <div class="card-body table-responsive">
            <table class="teachers-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Photo</th>
                        <th>F.I.Sh</th>
                        <th>Passport / ID</th>
                        <th>Tug‘ilgan sana</th>
                        <th>Sinf</th>
                        <th>Status</th>
                        <th>Amallar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            {% if student.avatar %}
                                <img
                                    class="avatar avatar-img js-photo-preview"
                                    src="{{ student.avatar.url }}"
                                    alt=""
                                    data-photo-url="{{ student.avatar.url }}"
                                >
                            {% else %}
                                <div class="avatar">
                                    {{ student.first_name|first }}{{ student.last_name|first }}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="user-cell">
                                <div>
                                    {{ student.first_name }} {{ student.last_name }}
                                    {% if student.user.email %}
                                    <small>{{ student.user.email }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>{{ student.passport_id|default:"—" }}</td>
                        <td>{{ student.birth_date|date:"d M, Y"|default:"—" }}</td>
                        <td>
                            {% if student.enrollment %}
                                <span class="badge class">
                                    {{ student.enrollment.school_class.name }}
                                </span>
                            {% else %}—{% endif %}
                        </td>
                        <td>
                            {% if student.enrollment %}
                                <span
                                    class="status-badge {% if student.enrollment.is_active %}status-active{% else %}status-inactive{% endif %}"
                                    onclick="toggleStatus(this)"
                                    data-enrollment-id="{{ student.enrollment.id }}"
                                    style="cursor:pointer"
                                    title="Statusni o‘zgartirish"
                                >
                                    {% if student.enrollment.is_active %}Faol{% else %}Nofaol{% endif %}
                                </span>
                            {% else %}—{% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a
                                    href="{% url 'admin_panel:student_edit' student.id %}"
                                    class="action-btn edit"
                                    title="Tahrirlash"
                                >
                                    <i class="fa-solid fa-pen"></i>
                                </a>
                                <button
                                    class="action-btn delete"
                                    onclick="deleteStudent({{ student.id }})"
                                    title="O‘chirish"
                                >
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted" style="text-align:center;">Hech qanday o‘quvchi topilmadi</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

  {% if is_paginated %}
  <nav class="pagination" aria-label="Pagination">
    <a
      class="page-link {% if not page_obj.has_previous %}disabled{% endif %}"
      {% if page_obj.has_previous %}
      href="?page={{ page_obj.previous_page_number }}{% if qs %}&{{ qs }}{% endif %}"
      {% endif %}
    >
      Previous
    </a>

    {% for num in paginator.page_range %}
      {% if num == page_obj.number %}
        <span class="page-link active">{{ num }}</span>
      {% else %}
        <a class="page-link" href="?page={{ num }}{% if qs %}&{{ qs }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}

    <a
      class="page-link {% if not page_obj.has_next %}disabled{% endif %}"
      {% if page_obj.has_next %}
      href="?page={{ page_obj.next_page_number }}{% if qs %}&{{ qs }}{% endif %}"
      {% endif %}
    >
      Next
    </a>
  </nav>
  {% endif %}

        <div class="card-footer">
            <span>{{ students|length }} ta o‘quvchi ko‘rsatilmoqda</span>
        </div>
    </div>

</main>

<!-- Photo preview modal (small preview) -->
<div class="modal" id="photoPreviewModal" aria-hidden="true">
    <div class="photo-preview-card" role="dialog" aria-modal="true">
        <button type="button" class="photo-preview-close" aria-label="Yopish">&times;</button>
        <img id="photoPreviewImg" src="" alt="">
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterPanel = document.getElementById('filterPanel');
    const showBtn = document.getElementById('showFilterPanel');

    document.getElementById('closeFilterPanel').addEventListener('click', function() {
        filterPanel.classList.add('filter-panel-hidden');
        if (showBtn) showBtn.style.display = 'inline-flex';
    });

    // Photo preview logic:
    // Clicking on an avatar image opens a small modal preview.
    const modal = document.getElementById('photoPreviewModal');
    const previewImg = document.getElementById('photoPreviewImg');
    const closeBtn = modal ? modal.querySelector('.photo-preview-close') : null;

    const openPreview = (url) => {
        if (!modal || !previewImg) return;
        previewImg.src = url;
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
    };

    const closePreview = () => {
        if (!modal || !previewImg) return;
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        previewImg.src = '';
    };

    document.querySelectorAll('.js-photo-preview[data-photo-url]').forEach((el) => {
        el.style.cursor = 'pointer';
        el.addEventListener('click', () => {
            const url = el.getAttribute('data-photo-url');
            if (url) openPreview(url);
        });
    });

    if (closeBtn) closeBtn.addEventListener('click', closePreview);

    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closePreview();
        });
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePreview();
    });

    if (showBtn) {
        showBtn.addEventListener('click', function() {
            filterPanel.classList.remove('filter-panel-hidden');
            showBtn.style.display = 'none';
        });
    }
});
function deleteStudent(studentId) {
    if (!confirm("Rostdan o‘chirmoqchimisiz?")) return;

    fetch(`/admin-panel/students/${studentId}/delete/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("O‘chirishda xatolik yuz berdi");
        }
    })
    .catch(err => {
        console.error(err);
        alert("O‘chirishda xatolik yuz berdi");
    });
}

function toggleStatus(el) {
    const enrollmentId = el.dataset.enrollmentId;
    if (!enrollmentId) return;

    fetch(`/admin-panel/students/toggle-status/${enrollmentId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.is_active) {
            el.classList.remove("status-inactive");
            el.classList.add("status-active");
            el.textContent = "Faol";
        } else {
            el.classList.remove("status-active");
            el.classList.add("status-inactive");
            el.textContent = "Nofaol";
        }
    })
    .catch(err => {
        console.error(err);
        alert("Statusni o‘zgartirishda xatolik");
    });
}
</script>

{% endblock %}
